@if (isOpen) {
  <div class="modal-overlay" (click)="onCancel()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Edit Staff Member' : 'Add New Staff Member' }}</h2>
        <button type="button" class="close-button" (click)="onCancel()">&times;</button>
      </div>

      <form [formGroup]="staffForm" (ngSubmit)="onSubmit()" class="staff-form">
        @if (errorMessage) {
          <div class="error-message">
            {{ errorMessage }}
          </div>
        }

        <div class="form-grid">
          @if (isEditMode) {
            <!-- User Account Info (read-only when editing) -->
            <div class="form-group full-width">
              <h3 class="section-title">Linked User Account</h3>
            </div>
            <div class="form-group">
              <label>Email</label>
              <input
                type="email"
                formControlName="email"
                class="form-control"
                readonly
              />
            </div>
            <div class="form-group">
              <label>First Name</label>
              <input
                type="text"
                formControlName="firstName"
                class="form-control"
                readonly
              />
            </div>
            <div class="form-group">
              <label>Last Name</label>
              <input
                type="text"
                formControlName="lastName"
                class="form-control"
                readonly
              />
            </div>
            <div class="form-group">
              <label>Role</label>
              <input
                type="text"
                formControlName="role"
                class="form-control"
                readonly
              />
            </div>
          }

          @if (!isEditMode) {
            <!-- User Account Creation Section (only when creating new staff) -->
            <div class="form-group full-width">
              <h3 class="section-title">User Account Details</h3>
              <p class="section-description">A user account will be automatically created for this staff member</p>
            </div>

            <div class="form-group">
              <label for="email">Email <span class="required">*</span></label>
              <input
                type="email"
                id="email"
                formControlName="email"
                class="form-control"
                [class.error]="staffForm.get('email')?.invalid && staffForm.get('email')?.touched"
                placeholder="employee@example.com"
              />
              @if (staffForm.get('email')?.errors?.['required'] && staffForm.get('email')?.touched) {
                <span class="error-text">Email is required</span>
              }
              @if (staffForm.get('email')?.errors?.['email'] && staffForm.get('email')?.touched) {
                <span class="error-text">Please enter a valid email address</span>
              }
            </div>

            <div class="form-group">
              <label for="password">Password <span class="required">*</span></label>
              <input
                type="password"
                id="password"
                formControlName="password"
                class="form-control"
                [class.error]="staffForm.get('password')?.invalid && staffForm.get('password')?.touched"
                placeholder="Minimum 8 characters"
              />
              @if (staffForm.get('password')?.errors?.['required'] && staffForm.get('password')?.touched) {
                <span class="error-text">Password is required</span>
              }
              @if (staffForm.get('password')?.errors?.['minlength'] && staffForm.get('password')?.touched) {
                <span class="error-text">Password must be at least 8 characters</span>
              }
              @if (staffForm.get('password')?.errors?.['pattern'] && staffForm.get('password')?.touched) {
                <span class="error-text">Password must contain uppercase, lowercase, and number</span>
              }
              <small class="hint">Must contain at least one uppercase letter, one lowercase letter, and one number</small>
            </div>

            <div class="form-group">
              <label for="firstName">First Name</label>
              <input
                type="text"
                id="firstName"
                formControlName="firstName"
                class="form-control"
                placeholder="Optional"
              />
            </div>

            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input
                type="text"
                id="lastName"
                formControlName="lastName"
                class="form-control"
                placeholder="Optional"
              />
            </div>

            <div class="form-group">
              <label for="role">User Role</label>
              <select id="role" formControlName="role" class="form-control">
                <option value="user">User</option>
                <option value="manager">Manager</option>
                <option value="warehouse">Warehouse</option>
                <option value="admin">Admin</option>
              </select>
            </div>
          }

          <div class="form-group full-width">
            <h3 class="section-title">Staff Information</h3>
          </div>

          <div class="form-group">
            <label for="employeeId">Employee ID <span class="required">*</span></label>
            <input
              type="text"
              id="employeeId"
              formControlName="employeeId"
              class="form-control"
              [class.error]="staffForm.get('employeeId')?.invalid && staffForm.get('employeeId')?.touched"
            />
            @if (staffForm.get('employeeId')?.invalid && staffForm.get('employeeId')?.touched) {
              <span class="error-text">Employee ID is required</span>
            }
          </div>

          <div class="form-group">
            <label for="department">Department</label>
            <input
              type="text"
              id="department"
              formControlName="department"
              class="form-control"
              placeholder="e.g., Sales, Warehouse, Management"
            />
          </div>

          <div class="form-group">
            <label for="position">Position</label>
            <input
              type="text"
              id="position"
              formControlName="position"
              class="form-control"
              placeholder="e.g., Manager, Staff, Supervisor"
            />
          </div>

          <div class="form-group">
            <label for="hireDate">Hire Date</label>
            <input
              type="date"
              id="hireDate"
              formControlName="hireDate"
              class="form-control"
            />
          </div>

          <div class="form-group">
            <label for="phoneNumber">Phone Number</label>
            <input
              type="tel"
              id="phoneNumber"
              formControlName="phoneNumber"
              class="form-control"
              placeholder="+1234567890"
            />
          </div>

          <div class="form-group">
            <label for="salary">Salary</label>
            <input
              type="number"
              id="salary"
              formControlName="salary"
              class="form-control"
              min="0"
              step="0.01"
              placeholder="0.00"
            />
            @if (staffForm.get('salary')?.invalid && staffForm.get('salary')?.touched) {
              <span class="error-text">Salary must be 0 or greater</span>
            }
          </div>

          @if (isEditMode) {
            <div class="form-group">
              <label for="isActive">Status</label>
              <select id="isActive" formControlName="isActive" class="form-control">
                <option [value]="true">Active</option>
                <option [value]="false">Inactive</option>
              </select>
            </div>
          }

          <div class="form-group full-width">
            <label for="address">Address</label>
            <textarea
              id="address"
              formControlName="address"
              class="form-control"
              rows="3"
              placeholder="Full address"
            ></textarea>
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" (click)="onCancel()" [disabled]="isSubmitting">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="staffForm.invalid || isSubmitting">
            @if (isSubmitting) {
              Saving...
            } @else {
              {{ isEditMode ? 'Update' : 'Create' }} Staff Member
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}
